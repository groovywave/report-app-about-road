<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚«ãƒ¡ãƒ©æ¨©é™è¦æ±‚ - åŸºæœ¬ç‰ˆ</title>
    <style>
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            line-height: 1.6;
        }
        
        .container {
            max-width: 420px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            padding: 32px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }
        
        .header {
            text-align: center;
            margin-bottom: 32px;
        }
        
        .camera-icon {
            font-size: 64px;
            margin-bottom: 16px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        h1 {
            color: #333;
            margin: 0 0 12px 0;
            font-size: 28px;
            font-weight: 700;
        }
        
        .description {
            color: #666;
            font-size: 15px;
            margin-bottom: 32px;
            line-height: 1.5;
        }
        
        .button {
            width: 100%;
            padding: 18px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 16px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .primary-button {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(79, 172, 254, 0.3);
        }
        
        .primary-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(79, 172, 254, 0.4);
        }
        
        .primary-button:active {
            transform: translateY(0);
        }
        
        .primary-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .secondary-button {
            background-color: #f8f9fa;
            color: #666;
            border: 2px solid #e9ecef;
        }
        
        .secondary-button:hover:not(:disabled) {
            background-color: #e9ecef;
            border-color: #dee2e6;
        }
        
        .status {
            padding: 16px;
            border-radius: 12px;
            margin-top: 20px;
            font-size: 14px;
            font-weight: 500;
            display: none;
        }
        
        .status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status.info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .status.warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .video-container {
            margin-top: 24px;
            text-align: center;
            background-color: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            display: none;
        }
        
        #cameraPreview {
            width: 100%;
            max-width: 320px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .permission-info {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            border: 1px solid #ffeaa7;
            border-radius: 12px;
            padding: 16px;
            margin-top: 20px;
            font-size: 13px;
            color: #856404;
        }
        
        .permission-info strong {
            display: block;
            margin-bottom: 8px;
            color: #533f03;
        }
        
        .device-info {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 12px;
            margin-top: 16px;
            font-size: 12px;
            color: #666;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4facfe;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .feature-list {
            margin-top: 20px;
            padding: 16px;
            background-color: #f8f9fa;
            border-radius: 12px;
        }
        
        .feature-list h3 {
            margin: 0 0 12px 0;
            color: #333;
            font-size: 16px;
        }
        
        .feature-list ul {
            margin: 0;
            padding-left: 20px;
            color: #666;
        }
        
        .feature-list li {
            margin-bottom: 4px;
        }
        
        @media (max-width: 480px) {
            .container {
                margin: 10px;
                padding: 24px;
            }
            
            h1 {
                font-size: 24px;
            }
            
            .camera-icon {
                font-size: 48px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="camera-icon">ğŸ“·</div>
            <h1>ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯</h1>
            <p class="description">
                ã“ã®æ©Ÿèƒ½ã‚’ä½¿ç”¨ã™ã‚‹ã«ã¯ã€ã‚«ãƒ¡ãƒ©ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ãŒå¿…è¦ã§ã™ã€‚<br>
                ãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰æ¨©é™è¦æ±‚ãŒè¡¨ç¤ºã•ã‚ŒãŸã‚‰ã€Œè¨±å¯ã€ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚
            </p>
        </div>
        
        <button id="requestPermission" class="button primary-button">
            ğŸ“· ã‚«ãƒ¡ãƒ©æ¨©é™ã‚’è¦æ±‚
        </button>
        
        <button id="checkStatus" class="button secondary-button">
            ğŸ” æ¨©é™çŠ¶æ…‹ã‚’ç¢ºèª
        </button>
        
        <button id="returnToForm" class="button secondary-button" style="display: none;">
            â†©ï¸ é€šå ±ãƒ•ã‚©ãƒ¼ãƒ ã«æˆ»ã‚‹
        </button>
        
        <div id="status" class="status"></div>
        
        <div class="video-container" id="videoContainer">
            <video id="cameraPreview" autoplay muted playsinline></video>
            <p style="margin-top: 12px; color: #666; font-size: 14px;">
                ã‚«ãƒ¡ãƒ©ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
            </p>
        </div>
        
        <div class="permission-info">
            <strong>ğŸ“± ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ã§ã®è¨­å®šæ–¹æ³•ï¼š</strong>
            <div style="margin-top: 8px;">
                <strong>Android:</strong> è¨­å®š â†’ ã‚¢ãƒ—ãƒª â†’ ãƒ–ãƒ©ã‚¦ã‚¶ â†’ æ¨©é™ â†’ ã‚«ãƒ¡ãƒ© â†’ ã€Œã‚¢ãƒ—ãƒªã®ä½¿ç”¨ä¸­ã®ã¿è¨±å¯ã€<br>
                <strong>iPhone:</strong> è¨­å®š â†’ Safari â†’ ã‚«ãƒ¡ãƒ© â†’ ã€Œç¢ºèªã€ã¾ãŸã¯ã€Œè¨±å¯ã€
            </div>
        </div>
        
        <div class="feature-list">
            <h3>ğŸ”§ ã“ã®æ©Ÿèƒ½ã«ã¤ã„ã¦</h3>
            <ul>
                <li>ã‚«ãƒ¡ãƒ©æ¨©é™ã®è¦æ±‚ã¨ç®¡ç†</li>
                <li>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º</li>
                <li>ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã¨å¾©æ—§æ”¯æ´</li>
                <li>ãƒ‡ãƒã‚¤ã‚¹åˆ¥ã®è¨­å®šã‚¬ã‚¤ãƒ‰</li>
                <li>HTTPSæ¥ç¶šã®è‡ªå‹•ç¢ºèª</li>
            </ul>
        </div>
        
        <div class="device-info" id="deviceInfo">
            <strong>ã‚·ã‚¹ãƒ†ãƒ æƒ…å ±:</strong><br>
            <span id="browserInfo">ãƒ–ãƒ©ã‚¦ã‚¶æƒ…å ±ã‚’å–å¾—ä¸­...</span>
        </div>
    </div>

    <script>
        // ã‚«ãƒ¡ãƒ©æ¨©é™è¦æ±‚ã®æ”¹è‰¯å®Ÿè£…
        class EnhancedCameraPermissionManager {
            constructor() {
                this.video = document.getElementById('cameraPreview');
                this.statusDiv = document.getElementById('status');
                this.requestButton = document.getElementById('requestPermission');
                this.checkButton = document.getElementById('checkStatus');
                this.videoContainer = document.getElementById('videoContainer');
                this.deviceInfo = document.getElementById('deviceInfo');
                this.browserInfo = document.getElementById('browserInfo');
                this.currentStream = null;
                this.permissionState = 'unknown';
                
                this.init();
            }
            
            init() {
                // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
                this.requestButton.addEventListener('click', () => {
                    this.requestCameraPermission();
                });
                
                this.checkButton.addEventListener('click', () => {
                    this.checkPermissionStatus();
                });
                
                // é€šå ±ãƒ•ã‚©ãƒ¼ãƒ ã«æˆ»ã‚‹ãƒœã‚¿ãƒ³ã®è¨­å®š
                const returnButton = document.getElementById('returnToForm');
                if (returnButton) {
                    returnButton.addEventListener('click', () => {
                        this.returnToReportForm();
                    });
                }
                
                // åˆæœŸåŒ–å‡¦ç†
                this.updateDeviceInfo();
                this.checkEnvironment();
                this.checkPermissionStatus();
                
                // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ã€é€šå ±ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰æ¥ãŸå ´åˆã¯æˆ»ã‚‹ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
                this.checkReferrer();
            }
            
            updateDeviceInfo() {
                const ua = navigator.userAgent;
                let browserName = 'Unknown';
                let osName = 'Unknown';
                
                // ãƒ–ãƒ©ã‚¦ã‚¶åˆ¤å®š
                if (ua.includes('Chrome')) browserName = 'Chrome';
                else if (ua.includes('Firefox')) browserName = 'Firefox';
                else if (ua.includes('Safari') && !ua.includes('Chrome')) browserName = 'Safari';
                else if (ua.includes('Edge')) browserName = 'Edge';
                
                // OSåˆ¤å®š
                if (ua.includes('Windows')) osName = 'Windows';
                else if (ua.includes('Mac')) osName = 'macOS';
                else if (ua.includes('Linux')) osName = 'Linux';
                else if (ua.includes('Android')) osName = 'Android';
                else if (ua.includes('iPhone') || ua.includes('iPad')) osName = 'iOS';
                
                this.browserInfo.textContent = `${browserName} on ${osName}`;
            }
            
            checkEnvironment() {
                // HTTPSæ¥ç¶šã®ç¢ºèª
                if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
                    this.updateStatus('âš ï¸ ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹ã«ã¯HTTPSæ¥ç¶šãŒå¿…è¦ã§ã™ã€‚<br><small>æœ¬ç•ªç’°å¢ƒã§ã¯HTTPSæ¥ç¶šã‚’ã”ä½¿ç”¨ãã ã•ã„ã€‚</small>', 'error');
                    this.requestButton.disabled = true;
                    return false;
                }
                
                // getUserMedia APIã®ã‚µãƒãƒ¼ãƒˆç¢ºèª
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    this.updateStatus('âŒ ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯ã‚«ãƒ¡ãƒ©APIãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚<br><small>æœ€æ–°ã®ãƒ–ãƒ©ã‚¦ã‚¶ã‚’ã”ä½¿ç”¨ãã ã•ã„ã€‚</small>', 'error');
                    this.requestButton.disabled = true;
                    return false;
                }
                
                this.updateStatus('âœ… ç’°å¢ƒãƒã‚§ãƒƒã‚¯å®Œäº†ã€‚ã‚«ãƒ¡ãƒ©æ©Ÿèƒ½ãŒåˆ©ç”¨å¯èƒ½ã§ã™ã€‚', 'success');
                return true;
            }
            
            async checkPermissionStatus() {
                try {
                    if (navigator.permissions) {
                        const permission = await navigator.permissions.query({name: 'camera'});
                        this.permissionState = permission.state;
                        
                        const statusText = this.getPermissionStatusText(permission.state);
                        this.updateStatus(`ğŸ” ç¾åœ¨ã®æ¨©é™çŠ¶æ…‹: ${statusText}`, 'info');
                        
                        // æ¨©é™çŠ¶æ…‹ã«å¿œã˜ã¦ãƒœã‚¿ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’æ›´æ–°
                        this.updateButtonState(permission.state);
                        
                        // æ¨©é™çŠ¶æ…‹ã®å¤‰æ›´ã‚’ç›£è¦–
                        permission.addEventListener('change', () => {
                            this.permissionState = permission.state;
                            const newStatusText = this.getPermissionStatusText(permission.state);
                            this.updateStatus(`ğŸ”„ æ¨©é™çŠ¶æ…‹ãŒå¤‰æ›´ã•ã‚Œã¾ã—ãŸ: ${newStatusText}`, 'info');
                            this.updateButtonState(permission.state);
                        });
                    } else {
                        this.updateStatus('â„¹ï¸ Permission APIæœªã‚µãƒãƒ¼ãƒˆ - æ¨©é™çŠ¶æ…‹ã‚’ç›´æ¥ç¢ºèªã§ãã¾ã›ã‚“', 'warning');
                    }
                } catch (error) {
                    console.error('Permission check error:', error);
                    this.updateStatus('âš ï¸ æ¨©é™çŠ¶æ…‹ã®ç¢ºèªä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'warning');
                }
            }
            
            updateButtonState(permissionState) {
                switch(permissionState) {
                    case 'granted':
                        this.requestButton.textContent = 'ğŸ“· ã‚«ãƒ¡ãƒ©ã‚’é–‹å§‹';
                        this.requestButton.className = 'button primary-button';
                        break;
                    case 'denied':
                        this.requestButton.textContent = 'ğŸ”„ æ¨©é™è¨­å®šã‚’ç¢ºèª';
                        this.requestButton.className = 'button secondary-button';
                        break;
                    case 'prompt':
                        this.requestButton.textContent = 'ğŸ“· ã‚«ãƒ¡ãƒ©æ¨©é™ã‚’è¦æ±‚';
                        this.requestButton.className = 'button primary-button';
                        break;
                    default:
                        this.requestButton.textContent = 'ğŸ“· ã‚«ãƒ¡ãƒ©æ¨©é™ã‚’è¦æ±‚';
                        this.requestButton.className = 'button primary-button';
                }
            }
            
            getPermissionStatusText(state) {
                switch(state) {
                    case 'granted': return 'è¨±å¯æ¸ˆã¿ âœ…';
                    case 'denied': return 'æ‹’å¦æ¸ˆã¿ âŒ';
                    case 'prompt': return 'æœªè¨­å®šï¼ˆç¢ºèªãŒå¿…è¦ï¼‰ â³';
                    default: return 'ä¸æ˜ â“';
                }
            }
            
            async requestCameraPermission() {
                // ãƒœã‚¿ãƒ³çŠ¶æ…‹ã®æ›´æ–°
                this.requestButton.disabled = true;
                const originalText = this.requestButton.textContent;
                this.requestButton.innerHTML = '<span class="loading"></span>æ¨©é™è¦æ±‚ä¸­...';
                
                this.updateStatus('ğŸ“· ã‚«ãƒ¡ãƒ©æ¨©é™ã‚’è¦æ±‚ã—ã¦ã„ã¾ã™...', 'info');
                
                try {
                    // æ”¹è‰¯ã•ã‚ŒãŸã‚«ãƒ¡ãƒ©åˆ¶ç´„è¨­å®š
                    const constraints = this.getOptimalConstraints();
                    console.log('Camera constraints:', constraints);
                    
                    const stream = await navigator.mediaDevices.getUserMedia(constraints);
                    
                    // æˆåŠŸæ™‚ã®å‡¦ç†
                    this.handlePermissionGranted(stream);
                    
                } catch (error) {
                    // ã‚¨ãƒ©ãƒ¼æ™‚ã®å‡¦ç†
                    this.handlePermissionError(error);
                } finally {
                    // ãƒœã‚¿ãƒ³çŠ¶æ…‹ã®å¾©å…ƒ
                    this.requestButton.disabled = false;
                    this.requestButton.innerHTML = originalText;
                }
            }
            
            getOptimalConstraints() {
                const isMobile = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                
                if (isMobile) {
                    return {
                        video: {
                            facingMode: { ideal: 'environment' }, // èƒŒé¢ã‚«ãƒ¡ãƒ©ã‚’å„ªå…ˆ
                            width: { ideal: 1280, min: 640 },
                            height: { ideal: 720, min: 480 },
                            frameRate: { ideal: 30, min: 15 }
                        },
                        audio: false
                    };
                } else {
                    return {
                        video: {
                            width: { ideal: 1920, min: 1280 },
                            height: { ideal: 1080, min: 720 },
                            frameRate: { ideal: 30 }
                        },
                        audio: false
                    };
                }
            }
            
            handlePermissionGranted(stream) {
                this.currentStream = stream;
                this.video.srcObject = stream;
                
                // iOS Safariå¯¾å¿œ
                this.video.setAttribute('autoplay', '');
                this.video.setAttribute('muted', '');
                this.video.setAttribute('playsinline', '');
                
                this.videoContainer.style.display = 'block';
                
                // ã‚¹ãƒˆãƒªãƒ¼ãƒ æƒ…å ±ã®è¡¨ç¤º
                const videoTrack = stream.getVideoTracks()[0];
                if (videoTrack) {
                    const settings = videoTrack.getSettings();
                    this.updateStatus(
                        `âœ… ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹ãŒè¨±å¯ã•ã‚Œã¾ã—ãŸï¼<br>` +
                        `<small>è§£åƒåº¦: ${settings.width}x${settings.height}, ` +
                        `ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¬ãƒ¼ãƒˆ: ${settings.frameRate}fps</small><br><br>` +
                        `<strong>ğŸ‰ è¨­å®šå®Œäº†ï¼</strong><br>` +
                        `é€šå ±ãƒ•ã‚©ãƒ¼ãƒ ã§ã‚«ãƒ¡ãƒ©æ©Ÿèƒ½ãŒä½¿ç”¨ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚`, 
                        'success'
                    );
                } else {
                    this.updateStatus(
                        'âœ… ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹ãŒè¨±å¯ã•ã‚Œã¾ã—ãŸï¼<br><br>' +
                        '<strong>ğŸ‰ è¨­å®šå®Œäº†ï¼</strong><br>' +
                        'é€šå ±ãƒ•ã‚©ãƒ¼ãƒ ã§ã‚«ãƒ¡ãƒ©æ©Ÿèƒ½ãŒä½¿ç”¨ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚', 
                        'success'
                    );
                }
                
                this.requestButton.textContent = 'ğŸ“· ã‚«ãƒ¡ãƒ©ã‚’åœæ­¢';
                this.requestButton.onclick = () => this.stopCamera();
                
                // é€šå ±ãƒ•ã‚©ãƒ¼ãƒ ã«æˆ»ã‚‹ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
                const returnButton = document.getElementById('returnToForm');
                if (returnButton) {
                    returnButton.style.display = 'block';
                }
                
                console.log('Camera access granted successfully');
            }
            
            checkReferrer() {
                // ãƒªãƒ•ã‚¡ãƒ©ãƒ¼ã¾ãŸã¯URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§é€šå ±ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰æ¥ãŸã‹ãƒã‚§ãƒƒã‚¯
                const urlParams = new URLSearchParams(window.location.search);
                const fromForm = urlParams.get('from') === 'report-form';
                const referrer = document.referrer;
                const isFromReportForm = fromForm || referrer.includes('index.html') || referrer.includes('report');
                
                if (isFromReportForm) {
                    const returnButton = document.getElementById('returnToForm');
                    if (returnButton) {
                        returnButton.style.display = 'block';
                    }
                    
                    // èª¬æ˜æ–‡ã‚’æ›´æ–°
                    const description = document.querySelector('.description');
                    if (description) {
                        description.innerHTML = `
                            ã‚«ãƒ¡ãƒ©æ©Ÿèƒ½ã‚’ä½¿ç”¨ã™ã‚‹ã«ã¯ã€ã‚«ãƒ¡ãƒ©ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ãŒå¿…è¦ã§ã™ã€‚<br>
                            ãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰æ¨©é™è¦æ±‚ãŒè¡¨ç¤ºã•ã‚ŒãŸã‚‰ã€Œè¨±å¯ã€ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚<br><br>
                            <strong style="color: #4facfe;">ğŸ“‹ é€šå ±ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰ç§»å‹•ã—ã¦ãã¾ã—ãŸ</strong>
                        `;
                    }
                }
            }
            
            returnToReportForm() {
                try {
                    // å…ƒã®ã‚¿ãƒ–ãŒå­˜åœ¨ã™ã‚‹å ´åˆã¯é–‰ã˜ã¦å…ƒã®ã‚¿ãƒ–ã«æˆ»ã‚‹
                    if (window.opener && !window.opener.closed) {
                        window.opener.focus();
                        window.close();
                    } else {
                        // å…ƒã®ã‚¿ãƒ–ãŒãªã„å ´åˆã¯ç›´æ¥ç§»å‹•
                        window.location.href = 'index.html';
                    }
                } catch (error) {
                    console.error('é€šå ±ãƒ•ã‚©ãƒ¼ãƒ ã«æˆ»ã‚‹éš›ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ:', error);
                    // ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯ç›´æ¥ç§»å‹•
                    window.location.href = 'index.html';
                }
            }
            
            handlePermissionError(error) {
                let message = 'ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹ã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
                let userGuidance = '';
                let statusType = 'error';
                
                switch(error.name) {
                    case 'NotAllowedError':
                        message = 'âŒ ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸã€‚';
                        userGuidance = 'ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒãƒ¼ã«ã‚ã‚‹ã‚«ãƒ¡ãƒ©ã‚¢ã‚¤ã‚³ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦è¨±å¯ã«å¤‰æ›´ã™ã‚‹ã‹ã€ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã§ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚';
                        break;
                    case 'NotFoundError':
                        message = 'âŒ ã‚«ãƒ¡ãƒ©ãƒ‡ãƒã‚¤ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚';
                        userGuidance = 'ãƒ‡ãƒã‚¤ã‚¹ã«ã‚«ãƒ¡ãƒ©ãŒæ¥ç¶šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
                        break;
                    case 'NotSupportedError':
                        message = 'âŒ ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯ã‚«ãƒ¡ãƒ©ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚';
                        userGuidance = 'æœ€æ–°ã®ãƒ–ãƒ©ã‚¦ã‚¶ã‚’ã”ä½¿ç”¨ãã ã•ã„ã€‚';
                        break;
                    case 'NotReadableError':
                        message = 'âŒ ã‚«ãƒ¡ãƒ©ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“ã€‚';
                        userGuidance = 'ä»–ã®ã‚¢ãƒ—ãƒªï¼ˆZoomã€Skypeç­‰ï¼‰ãŒã‚«ãƒ¡ãƒ©ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ãã‚Œã‚‰ã®ã‚¢ãƒ—ãƒªã‚’çµ‚äº†ã—ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚';
                        break;
                    case 'OverconstrainedError':
                        message = 'âŒ ã‚«ãƒ¡ãƒ©ã®è¨­å®šã«å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚';
                        userGuidance = 'è¦æ±‚ã•ã‚ŒãŸã‚«ãƒ¡ãƒ©è¨­å®šãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚';
                        statusType = 'warning';
                        break;
                    case 'SecurityError':
                        message = 'âŒ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚';
                        userGuidance = 'HTTPSæ¥ç¶šãŒå¿…è¦ã§ã™ã€‚';
                        break;
                    default:
                        message = `âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`;
                        userGuidance = 'ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚';
                }
                
                this.updateStatus(
                    `${message}<br><small><strong>å¯¾å‡¦æ³•:</strong> ${userGuidance}</small>`, 
                    statusType
                );
                
                console.error('Camera access error:', error);
            }
            
            stopCamera() {
                if (this.currentStream) {
                    this.currentStream.getTracks().forEach(track => track.stop());
                    this.currentStream = null;
                }
                
                this.videoContainer.style.display = 'none';
                this.video.srcObject = null;
                this.updateStatus('ğŸ“· ã‚«ãƒ¡ãƒ©ãŒåœæ­¢ã•ã‚Œã¾ã—ãŸã€‚', 'info');
                this.requestButton.textContent = 'ğŸ“· ã‚«ãƒ¡ãƒ©ã‚’é–‹å§‹';
                this.requestButton.onclick = () => this.requestCameraPermission();
            }
            
            updateStatus(message, type) {
                this.statusDiv.innerHTML = message;
                this.statusDiv.className = `status ${type}`;
                this.statusDiv.style.display = 'block';
            }
        }
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†å¾Œã«åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', () => {
            window.cameraManager = new EnhancedCameraPermissionManager();
        });
        
        // ãƒšãƒ¼ã‚¸é›¢è„±æ™‚ã«ã‚«ãƒ¡ãƒ©ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’åœæ­¢
        window.addEventListener('beforeunload', () => {
            if (window.cameraManager && window.cameraManager.currentStream) {
                window.cameraManager.currentStream.getTracks().forEach(track => track.stop());
            }
        });
    </script>
</body>
</html>


